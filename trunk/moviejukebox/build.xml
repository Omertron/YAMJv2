<project name="moviejukebox" default="all" basedir=".">

    <target name="all" depends="clean, compile, test, delivery" />

    <target name="init">
        <property name="version" value="v2.3 BETA" />
        <!-- This only works if the build is done through Hudson, otherwise it stays the same -->
        <property environment="env" />
    	
        <!-- Get the revision information from SVN -->
        <property environment="env" />
        <condition property="revision" value="${env.SVN_REVISION}" else="0000">
            <isset property="env.SVN_REVISION" />
        </condition>

        <echo>Writing version.txt</echo>
        <tstamp>
            <format property="builddate" pattern="yyyy-MM-dd HH:mm:ss" locale="en"/>
        </tstamp> 
        <echo file="conf/version.txt" append="false">Yet Another Movie Jukebox${line.separator}</echo>
        <echo file="conf/version.txt" append="true">Build Date: ${builddate}${line.separator}</echo>
        <echo file="conf/version.txt" append="true">Version: ${version}${line.separator}</echo>
        <echo file="conf/version.txt" append="true">Revision: r${env.SVN_REVISION}${line.separator}</echo>
    </target>

    <target name="clean">
        <delete dir="build" />
        <delete includeemptydirs="true" failonerror="false">
            <fileset dir="dist" includes="**/*" excludes="mediaInfo/*" followsymlinks="false" />
        </delete>
    </target>

    <target name="prepare" depends="init">
        <mkdir dir="build/classes" />
        <mkdir dir="dist" />
    </target>

    <target name="compile" depends="prepare,jaxb">
        <javac debug="true" encoding="utf-8" nowarn="true" source="1.6" destdir="build/classes" srcdir="build/jaxb:src">
            <classpath>
                <fileset dir="lib">
                    <include name="**/*.jar" />
                </fileset>
            </classpath>
        </javac>
    </target>

    <target name="prepare-test">
        <mkdir dir="build/test" />
        <mkdir dir="build/report" />
    </target>

    <target name="compile-test" depends="prepare-test, compile">
        <javac debug="true" encoding="utf-8" destdir="build/test" srcdir="test">
            <classpath>
                <pathelement path="build/classes" />
                <fileset dir="lib">
                    <include name="**/*.jar" />
                </fileset>
            </classpath>
        </javac>
    </target>

    <target name="test" depends="compile-test">
        <junit forkmode="once" fork="yes" printsummary="yes" haltonfailure="no" failureproperty="tests.failed" showoutput="true">
            <jvmarg value="-Dfile.encoding=UTF-8" />
            <classpath>
                <fileset dir="lib">
                    <include name="**/*.jar" />
                </fileset>
                <pathelement path="build/classes" />
                <pathelement path="build/test" />
                <pathelement path="conf" />
            </classpath>
            <formatter type="xml" />
            <formatter type="plain" />
            <batchtest todir="build/report">
                <fileset dir="build/test">
                    <include name="**/*Test.class" />
                    <include name="**/*TestCase.class" />
                    <exclude name="**/*PosterPluginTestCase.class" />
                </fileset>
            </batchtest>
        </junit>
        <junitreport todir="build/report">
            <report format="frames" todir="build/report/html" />
            <fileset dir="build/report">
                <include name="TEST-*.xml" />
            </fileset>
        </junitreport>
        <fail if="tests.failed">
      tests.failed=${tests.failed}
      ****************************************************************
      **** One or more tests failed! Check the tests report ... ****
      ****************************************************************
    </fail>
    </target>

    <target name="test-poster-plugin" depends="compile-test">
        <junit forkmode="once" fork="yes" printsummary="yes" haltonfailure="no" failureproperty="tests.failed" showoutput="true">
            <classpath>
                <fileset dir="lib">
                    <include name="**/*.jar" />
                </fileset>
                <pathelement path="build/classes" />
                <pathelement path="build/test" />
                <pathelement path="conf" />
            </classpath>
            <formatter type="xml" />
            <formatter type="plain" />
            <batchtest todir="build/report">
                <fileset dir="build/test">
                    <include name="**/*PosterPluginTestCase.class" />
                </fileset>
            </batchtest>
        </junit>
        <junitreport todir="build/report">
            <report format="frames" todir="build/report/html" />
            <fileset dir="build/report">
                <include name="TEST-*.xml" />
            </fileset>
        </junitreport>
        <fail if="tests.failed">
          tests.failed=${tests.failed}
          ****************************************************************
          **** One or more tests failed! Check the tests report ... ****
          ****************************************************************
        </fail>
    </target>

    <!-- =====================================================
          target: jaxb

          Generate code from schema (xsd) files.

          This illustrates the usage of the XmlElementWrapper
          plugin for JAXB xjc.
         ===================================================== -->
    <target name="jaxb" depends="prepare" description="Build code from schema files...">

        <mkdir dir="build/jaxb/com/moviejukebox/jaxb/allocine" />

        <!-- classpath for jaxb library -->
        <path id="cp.jaxb">
            <fileset dir="lib/jaxb" includes="*.jar" />
        </path>
        <!-- classpath for xew plugin -->
        <path id="cp.plugin">
            <fileset dir="lib/xjc-plugin" includes="*.jar" />
        </path>

        <!-- Ant task definition for the xjc tool -->
        <taskdef name="xjc" classname="com.sun.tools.xjc.XJCTask">
          <classpath>
            <path refid="cp.jaxb" />
            <path refid="cp.plugin" />
          </classpath>
        </taskdef>

        <xjc destdir="build/jaxb" package="com.moviejukebox.jaxb.allocine" extension="Yes">
            <!-- <arg value="-debug" /> -->
            <!-- <arg value="-verbose" /> -->
            <arg value="-Xxew" />
            <arg value="-summary build/allocine-xew-summary.txt" />
            <arg value="-instantiate lazy" />
            <arg value="-delete" />
            <schema dir="schemas" includes="allocine.xsd" />
            <!-- <binding dir="${etc}" includes="allocine.xjb" /> -->
            <produces dir="build/jaxb/com/moviejukebox/jaxb/allocine" includes="*" />
        </xjc>
    </target>

    <target name="delivery" depends="clean, compile">
        <mkdir dir="dist/lib" />

        <tstamp>
            <format property="TODAY" pattern="yyyy-MM-dd HH:mm:ss" />
        </tstamp>

        <manifest file="MANIFEST.MF">
            <attribute name="Built-By" value="${user.name}" />
            <attribute name="Specification-Title" value="Yet Another Movie Jukebox" />
            <attribute name="Specification-Version" value="${version}" />
            <attribute name="Implementation-Version" value="${revision}" />
            <attribute name="Implementation-Title" value="${TODAY}" />
        </manifest>

        <copy todir="build/classes/" overwrite="true">
            <fileset dir="resources">
                <include name="**/*.*" />
            </fileset>
        </copy>

        <jar destfile="dist/lib/${ant.project.name}.jar" basedir="build/classes" includes="**/*.class,META-INF/**" manifest="MANIFEST.MF" />

        <copy todir="dist/lib" includeEmptyDirs="No">
            <fileset dir="lib">
                <include name="**/*" />
                <exclude name="junit*.jar" />
                <exclude name="jaxb/*" />
                <exclude name="xjc-plugin/*" />
            </fileset>
        </copy>

        <copy todir="dist/lib" includeEmptyDirs="No">
            <fileset dir="lib/jaxb">
                <include name="jaxb-impl.jar" />
                <include name="jaxb-api.jar" />
                <include name="jsr173_1.0_api.jar" />
                <include name="activation.jar" />
            </fileset>
        </copy>

        <copy todir="dist">
            <fileset dir="conf">
                <include name="**/*" />
            </fileset>
        </copy>

        <copy todir="dist/skins">
            <fileset dir="skins">
                <include name="**/*" />
            </fileset>
        </copy>

        <copy todir="dist/notices">
            <fileset dir="notices">
                <include name="**/*" />
            </fileset>
        </copy>

        <!-- <zip basedir="dist" destfile="dist/moviejukebox_${version}.zip" excludes="mediaInfo/" followsymlinks="false" /> -->
    	
        <zip basedir="dist" destfile="dist/yamj-svn-r${revision}.zip" excludes="mediaInfo/" followsymlinks="false" />
    </target>
</project>
